name: Generate Wallpapers README

on:
  workflow_dispatch: # manual trigger
  workflow_run:
    workflows: ["Stole Wallpapers"]
    types:
      - completed

jobs:
  generate-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate README
        run: |
          TOTAL=$(find wallpapers -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' \) | wc -l)

          cat > README.md <<EOF
          # ðŸ–¼ Wallpapers
          A collection of **high-quality 4K aesthetic wallpapers**.  
          Perfect for desktops, backgrounds, and inspiration!
          
          ðŸš€ This repository updates **15 wallpapers every week**.
          
          ## Get all wallpapers
          \`\`\`sh
          git clone --depth 1 https://github.com/phucisstupid/wallpapers
          \`\`\`
          
          ## Why update weekly?
          - Perfect for people who like to **change their wallpaper daily** â†’ 15 wallpapers = 2 per day for a week.
          - Keeps the repo size small.

          ## Update
          Run this to always get the latest 15 wallpapers and drop old commits:

          \`\`\`sh
          git fetch origin && git reset --hard origin/main
          \`\`\`

          ## Gallery
          ðŸ’¡ Tip: Click on any image to view full-size. Enjoy your wallpapers!
          ![Total Wallpapers](https://img.shields.io/badge/Total-$TOTAL-blue)

          <table>
          <tr>
          EOF

          count=0
          find wallpapers -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' \) | sort | while read img; do
            echo "<td><a href=\"$img\"><img src=\"$img\" width=\"200\" /></a></td>" >> README.md
            count=$((count+1))
            if [ $count -eq 4 ]; then
              echo "</tr><tr>" >> README.md
              count=0
            fi
          done

          echo "</tr></table>" >> README.md

      - name: Commit and push
        run: |
          git add README.md
          git commit -m "Update README" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
